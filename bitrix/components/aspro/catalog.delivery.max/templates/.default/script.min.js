void 0===window.JCCatalogDelivery&&(window.JCCatalogDelivery=function(i,t,e){this.rand=i,this.timerPlusMinus=!1,this.params={},this.result={},this.$popup=!1,this.$block=!1,this.$form=!1,this.$error=!1,this.$baseFields=!1,"object"==typeof e&&(this.result=e),"object"==typeof t&&(this.params=t,this.init())},window.JCCatalogDelivery.prototype={init:function(){if(this.jsSolutionOptions="object"==typeof window.arMaxOptions&&window.arMaxOptions,this.ratio=this.result.PRODUCT.RATIO,this.ratio_is_float=this.result.PRODUCT.RATIO_IS_FLOAT,this.ratio=this.ratio_is_float?parseFloat(this.ratio):parseInt(this.ratio,10),this.ratio_is_float&&"object"==typeof this.jsSolutionOptions&&(this.ratio=Math.round(this.ratio*arMaxOptions.JS_ITEM_CLICK.precisionFactor)/arMaxOptions.JS_ITEM_CLICK.precisionFactor),this.$block=$("#catalog-delivery-"+this.rand),this.$block.length){this.$popup=this.$block.closest(".popup"),this.bPopup=0<this.$popup.length,this.$form=this.$block.find("form[name=catalog-delivery]"),this.$error=this.$block.find(".catalog-delivery-error-text"),this.$baseFields=this.$block.find(".catalog-delivery-fields-base"),this.$baseFields.length&&(this.maxBaseFieldsHeight=100);var i=this,t=setInterval(function(){i.$block.height()&&(clearInterval(t),"function"==typeof CheckPopupTop&&CheckPopupTop(),i.onResizeHandler())},100)}this.bindEvents()},sendForm:function(i){var t=this.result.AJAX_URL;if(t){i&&this.$form.append('<input type="hidden" name="CALCULATE" value="Y" />');var e=this.$form.serialize(),o=this;o.timerPlusMinus&&(clearTimeout(o.timerPlusMinus),o.timerPlusMinus=!1);var s="Y"===this.$form.find("input[name=LOCATION_CHANGED]").val(),a=this.$form.find("input[name=LOCATION]").val();i?$.ajax({url:t,type:"POST",data:e,beforeSend:function(){o.$block.addClass("sending")},success:function(i){o.$block.wrap("<div></div>");var t=o.$block.parent();t.html(i),o.$block=t.find(".catalog-delivery"),t.find(">div").unwrap("<div></div>"),s&&BX.onCustomEvent("onCatalogDeliveryChangeLocation",[{code:a}])},error:function(i,t,e){o.$block.addClass("haserror"),o.$error.text(BX.message.CD_T_ERROR_REQUEST+" "+e+" ("+i.status+")")},complete:function(){o.$form.find("input[name=CALCULATE]").remove(),o.$block.removeClass("sending")}}):$.ajax({url:t,type:"POST",data:e})}},bindEvents:function(){var a=this;if(this.$block.length){if(this.$form.length&&(this.$form.submit(function(i){i.preventDefault()}),this.$form.find("input, select").change(function(){$(this);"Y"===$(this).data("send")&&a.sendForm(!0)})),-1!==$.inArray("LOCATION",this.params.CHANGEABLE_FIELDS)&&(this.$block.find(".catalog-delivery-title-city").click(function(i){a.$block.addClass("search")}),this.$block.find("input[name=LOCATION_SEARCH]").change(function(i){var t=$(this),e=t.val();if(e.length){var o=t.closest(".bx-ui-sls-input-block").find(".bx-ui-sls-fake").val(),s=a.$form.find("input[name=LOCATION]").val();a.$block.find(".catalog-delivery-title-city>span").eq(0).html(o),a.$block.removeClass("search"),s!=e&&(a.$form.find("input[name=LOCATION_CHANGED]").val("Y"),a.$form.find("input[name=LOCATION]").val(e).change())}})),this.$block.find(".hasdropdown .catalog-delivery-field-box-value").click(function(){var i=$(this).closest(".catalog-delivery-field-box.open").length;$(".catalog-delivery-field-box.open").removeClass("open"),i||$(this).closest(".catalog-delivery-field-box").addClass("open")}),this.$block.find(".catalog-delivery-field-box-dropdown-item").click(function(){var i=$(this).attr("data-value"),t=$(this).closest(".catalog-delivery-field-box");if(t.length){var e=t.find("select");if(e.length)t.find(".catalog-delivery-field-box-value span").text($(this).text()),t.removeClass("open"),e.val()!=i&&e.val(i).change()}}),this.$block.find(".catalog-delivery-item-head").click(function(i){var t=$(this).closest(".catalog-delivery-item");t.length&&(t.toggleClass("open"),t.find(".catalog-delivery-item-more").slideToggle(),i.stopPropagation()),a.$form.find("input[name^=DELIVERY]").remove();var e=a.$block.find(".catalog-delivery-item.open").length;if(e)for(var o=0;o<e;++o)a.$form.append('<input type="hidden" name="DELIVERY['+o+']" value="'+a.$block.find(".catalog-delivery-item.open").eq(o).data("id")+'" />');else a.$form.append('<input type="hidden" name="DELIVERY[]" value="" />');"Y"===a.params.SAVE_IN_SESSION&&a.sendForm(!1)}),-1!==$.inArray("QUANTITY",this.params.CHANGEABLE_FIELDS)){var e=this.$block.find(".catalog-delivery-field_quantity .catalog-delivery-field-box-value input[type=text]");e.length&&(this.$block.find(".catalog-delivery-field_quantity .catalog-delivery-field-box-value .plus").click(function(i){a.timerPlusMinus&&(clearTimeout(a.timerPlusMinus),a.timerPlusMinus=!1);var t=e.val();t=a.ratio_is_float?parseFloat(t):parseInt(t,10),t+=a.ratio,"string"==typeof a.result.PRODUCT.MAX_QUANTITY_BUY&&t>a.result.PRODUCT.MAX_QUANTITY_BUY&&(t=a.result.PRODUCT.MAX_QUANTITY_BUY),t<a.ratio&&(t=a.ratio),a.ratio_is_float&&"object"==typeof a.jsSolutionOptions&&(t=Math.round(t*a.jsSolutionOptions.JS_ITEM_CLICK.precisionFactor)/a.jsSolutionOptions.JS_ITEM_CLICK.precisionFactor),e.val(t),a.result.PRODUCT_QUANTITY!=t&&(a.timerPlusMinus=setTimeout(function(){e.change()},1e3))}),this.$block.find(".catalog-delivery-field_quantity .catalog-delivery-field-box-value .minus").click(function(i){a.timerPlusMinus&&(clearTimeout(a.timerPlusMinus),a.timerPlusMinus=!1);var t=e.val();t=a.ratio_is_float?parseFloat(t):parseInt(t,10),t-=a.ratio,"string"==typeof a.result.PRODUCT.MAX_QUANTITY_BUY&&t>a.result.PRODUCT.MAX_QUANTITY_BUY&&(t=a.result.PRODUCT.MAX_QUANTITY_BUY),t<a.ratio&&(t=a.ratio),a.ratio_is_float&&"object"==typeof a.jsSolutionOptions&&(t=Math.round(t*a.jsSolutionOptions.JS_ITEM_CLICK.precisionFactor)/a.jsSolutionOptions.JS_ITEM_CLICK.precisionFactor),e.val(t),a.result.PRODUCT_QUANTITY!=t&&(a.timerPlusMinus=setTimeout(function(){e.change()},1e3))}),e.change(function(i){var t=$(this).val();"string"==typeof a.result.PRODUCT.MAX_QUANTITY_BUY&&t>a.result.PRODUCT.MAX_QUANTITY_BUY&&(t=a.result.PRODUCT.MAX_QUANTITY_BUY),(t=a.ratio_is_float?parseFloat(t):parseInt(t,10))>a.ratio?(diff=t%a.ratio,0<diff&&(t-=diff)):t=a.ratio,a.ratio_is_float&&"object"==typeof a.jsSolutionOptions&&(t=Math.round(t*a.jsSolutionOptions.JS_ITEM_CLICK.precisionFactor)/a.jsSolutionOptions.JS_ITEM_CLICK.precisionFactor),$(this).val(t)}),"function"==typeof $.fn.numeric&&e.numeric(this.ratio_is_float?{allow:"."}:{}))}this.$baseFields.length&&this.$block.find(".catalog-delivery-fields-opener").click(function(i){$(this).closest(".catalog-delivery-fields").toggleClass("open"),a.onResizeHandler()}),(this.$baseFields.length||this.bPopup)&&$(window).resize(function(){a.onResizeHandler()})}},onResizeHandler:function(){if(this.$baseFields.length){var i=this.$baseFields.height();this.$block.hasClass("shortfields")?i<=this.maxBaseFieldsHeight&&(this.$block.removeClass("shortfields"),"function"==typeof CheckPopupTop&&CheckPopupTop()):i>this.maxBaseFieldsHeight&&(this.$block.addClass("shortfields"),"function"==typeof CheckPopupTop&&CheckPopupTop())}this.bPopup&&window.matchMedia("(max-width:767px)").matches}},$(document).on("click",function(i){$(i.target).closest(".catalog-delivery-field-box.open").length||$(".catalog-delivery-field-box.open").removeClass("open")}));